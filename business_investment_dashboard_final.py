# real_installment_final_fixed.py
# ======================================================
# ğŸ’¼ Streamlit â€” Ù…Ø¯Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ù‚Ø³Ø§Ø· Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ 6â€ŒÙ…Ø§Ù‡Ù‡ (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ù†Ù‡Ø§ÛŒÛŒ)
# Ù…Ù†Ø·Ù‚:
# 1) Ù‡Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ 6 Ù…Ø§Ù‡Ù‡ Ø§Ø³Øª Ùˆ Ù‡Ø± Ù…Ø§Ù‡ 1/6 Ø§Ø² (Ø§ØµÙ„ + Ø³ÙˆØ¯Ù 6Ù…Ø§Ù‡Ù‡) Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø±Ø¯Ø§Ø²Ø¯.
# 2) Ø§Ù‚Ø³Ø§Ø·Ù Ø¯Ø±ÛŒØ§ÙØªÛŒÙ Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡ â†’ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù 6Ù…Ø§Ù‡Ù‡â€ŒÛŒ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø§Ù…Ø§ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒØ´ Ø§Ø² Â«Ù…Ø§Ù‡ Ø¨Ø¹Ø¯Â» Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
# 3) Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù¾Ø³ Ø§Ø² 6 Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.
# 4) Â«Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„Â» ÙÙ‚Ø· Ø´Ø§Ù…Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒÛŒ Ø§Ø³Øª Ú©Ù‡ Ù‡Ù…Ø§Ù† Ù…Ø§Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ§Ù†Ø¯ (pending Ø¯Ø± Ø¢Ù† Ù…Ø§Ù‡ Ø´Ù…Ø±Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯).
# ======================================================

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

# ---------- Setup ----------
st.set_page_config(page_title="Real Installment Model (Fixed)", layout="wide")
st.title("ğŸ’° Ù…Ø¯Ù„ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ù‚Ø³Ø§Ø· Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ â€” Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡")

st.caption("Ù…Ù†Ø·Ù‚ Ø¯Ù‚ÛŒÙ‚: Ø§Ù‚Ø³Ø§Ø·Ù Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒØŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù†Ø¯ Ú©Ù‡ Ø§Ø² **Ù…Ø§Ù‡ Ø¨Ø¹Ø¯** Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯Ø› "
           "Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒÛŒ Â«Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„Â» Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒØŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ ØªØ§Ø²Ù‡ (pending) Ø´Ù…Ø±Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.")

# ---------- Inputs ----------
col1, col2, col3 = st.columns(3)
with col1:
    principal = st.number_input("ğŸ’µ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø§ÙˆÙ„ÛŒÙ‡ (ØªÙˆÙ…Ø§Ù†)", value=100_000_000, step=1_000_000, format="%d")
with col2:
    months = st.number_input("â³ Ù…Ø¯Øª Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ (Ù…Ø§Ù‡)", value=12, min_value=1, step=1)
with col3:
    profit_6m_pct = st.number_input("ğŸ“ˆ Ø³ÙˆØ¯ Ú©Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Û¶â€ŒÙ…Ø§Ù‡Ù‡ (%)", value=36.0, step=0.5)

# Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§
CONTRACT_LEN = 6
total_return_factor = 1.0 + (profit_6m_pct / 100.0)     # Ù…Ø«Ù„Ø§ 1.36
monthly_payment_ratio = total_return_factor / CONTRACT_LEN  # Ø³Ù‡Ù… Ù‚Ø³Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡

# ---------- State ----------
# contracts: Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Â«Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÙ Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡Â»
# pending: Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Â«Ø§Ø² Ù…Ø§Ù‡ Ø¨Ø¹Ø¯Â» Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
contracts = [{"amount": principal, "months_left": CONTRACT_LEN}]
pending = []

records = []

# ---------- Simulation ----------
for m in range(1, int(months) + 1):
    # 1) Ø¯Ø±ÛŒØ§ÙØª Ø§Ù‚Ø³Ø§Ø· Ø§Ø² Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Â«Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÂ»
    monthly_income = 0.0
    next_active = []
    for c in contracts:
        pay = c["amount"] * monthly_payment_ratio
        monthly_income += pay
        c["months_left"] -= 1
        if c["months_left"] > 0:
            next_active.append(c)   # Ù‡Ù†ÙˆØ² Ù‚Ø³Ø· Ø¯Ø§Ø±Ø¯ â†’ Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ Ù‡Ù… Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø³Øª

    # 2) Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ pending Ø§Ø² Ù…Ø§Ù‡ Ù‚Ø¨Ù„ØŒ Ø§Ú©Ù†ÙˆÙ† ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ (Ø§Ù…Ø§ Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø¯Ø§Ø±Ù†Ø¯Ø›
    #    Ù¾Ø±Ø¯Ø§Ø®ØªØ´Ø§Ù† Ø§Ø² Ù…Ø§Ù‡Ù Ø¨Ø¹Ø¯Ù ÙØ¹Ø§Ù„â€ŒØ´Ø¯Ù† Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ú©Ù‡ Ø¨Ø§ Ù…Ù†Ø·Ù‚ Ø­Ù„Ù‚Ù‡ Ø­ÙØ¸ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    # Ù†Ú©ØªÙ‡: Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒÙ… Ø¢Ù†Ù‡Ø§ Â«Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡Â» Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù†Ù†Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø±Ø­Ù„Ù‡ (1) Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯Ø›
    #       Ø§Ù…Ø§ Ù…Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù†Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ….
    if pending:
        next_active.extend(pending)
        pending = []

    # 3) Ø§Ù‚Ø³Ø§Ø· Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡ â†’ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù Ø¬Ø¯ÛŒØ¯Ù 6 Ù…Ø§Ù‡Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯Ø› Ø§Ù…Ø§ Â«pendingÂ» ØªØ§ Ù…Ø§Ù‡ Ø¨Ø¹Ø¯
    if monthly_income > 0:
        pending.append({"amount": monthly_income, "months_left": CONTRACT_LEN})

    # 4) Ø¨Ø³ØªÙ† ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù‡
    contracts = next_active

    # Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„Ù Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡: ÙÙ‚Ø· Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Â«Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®ØªÂ»
    active_capital = sum(c["amount"] for c in contracts)

    # Ø¨Ø±Ø§ÛŒ Ø´ÙØ§ÙÛŒØª: Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¯Ø± ØµÙ (Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ù…Ø§Ù‡ Ø¨Ø¹Ø¯)
    pipeline_capital = sum(p["amount"] for p in pending)

    # Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯
    records.append({
        "Ù…Ø§Ù‡": m,
        "Ø§Ù‚Ø³Ø§Ø· Ø¯Ø±ÛŒØ§ÙØªÛŒ (ØªÙˆÙ…Ø§Ù†)": round(monthly_income),
        "ØªØ¹Ø¯Ø§Ø¯ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„": len(contracts),
        "Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ (ØªÙˆÙ…Ø§Ù†)": round(active_capital),
        "Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ø± ØµÙ Ø´Ø±ÙˆØ¹ (ØªØ¹Ø¯Ø§Ø¯)": len(pending),
        "Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¯Ø± ØµÙ (Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ø§Ù‡ Ø¨Ø¹Ø¯) (ØªÙˆÙ…Ø§Ù†)": round(pipeline_capital),
    })

# ---------- DataFrame ----------
df = pd.DataFrame(records)

# ---------- Table ----------
st.subheader("ğŸ§¾ Ø¬Ø¯ÙˆÙ„ Ù…Ø§Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø§Ù‡")
st.dataframe(df.style.format({
    "Ø§Ù‚Ø³Ø§Ø· Ø¯Ø±ÛŒØ§ÙØªÛŒ (ØªÙˆÙ…Ø§Ù†)": "{:,.0f}",
    "Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ (ØªÙˆÙ…Ø§Ù†)": "{:,.0f}",
    "Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¯Ø± ØµÙ (Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ø§Ù‡ Ø¨Ø¹Ø¯) (ØªÙˆÙ…Ø§Ù†)": "{:,.0f}",
}))

# ---------- Plots ----------
st.subheader("ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§")
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8), sharex=True)

# Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ + Ø§Ù‚Ø³Ø§Ø·
ax1.plot(df["Ù…Ø§Ù‡"], df["Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ (ØªÙˆÙ…Ø§Ù†)"], marker="o", linewidth=2, label="Ø³Ø±Ù…Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ (Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡)")
ax1.bar(df["Ù…Ø§Ù‡"], df["Ø§Ù‚Ø³Ø§Ø· Ø¯Ø±ÛŒØ§ÙØªÛŒ (ØªÙˆÙ…Ø§Ù†)"], alpha=0.6, label="Ø§Ù‚Ø³Ø§Ø· Ø¯Ø±ÛŒØ§ÙØªÛŒ (Ù‡Ù…ÛŒÙ† Ù…Ø§Ù‡)")
ax1.set_ylabel("ØªÙˆÙ…Ø§Ù†")
ax1.grid(True, linestyle="--", alpha=0.4)
ax1.legend()

# Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¯Ø± ØµÙ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ø¢ÛŒÙ†Ø¯Ù‡)
ax2.plot(df["Ù…Ø§Ù‡"], df["Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¯Ø± ØµÙ (Ø´Ø±ÙˆØ¹ Ø§Ø² Ù…Ø§Ù‡ Ø¨Ø¹Ø¯) (ØªÙˆÙ…Ø§Ù†)"], marker="o", linewidth=2, color="#8c6", label="Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø¯Ø± ØµÙ Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ø¨Ø¹Ø¯")
ax2.set_xlabel("Ù…Ø§Ù‡")
ax2.set_ylabel("ØªÙˆÙ…Ø§Ù†")
ax2.grid(True, linestyle="--", alpha=0.4)
ax2.legend()

st.pyplot(fig)

# ---------- CSV ----------
csv_data = df.to_csv(index=False).encode("utf-8-sig")
st.download_button("â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV", data=csv_data, file_name="real_installment_final_fixed_report.csv", mime="text/csv")
