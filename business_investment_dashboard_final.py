# ======================================================
# ๐ผ ูุฏู ูุงูุน ฺฏุฑุฏุด ุงูุณุงุท ุจุฑุง ฺฉุณุจโูโฺฉุงุฑ ุชู (ุงุตูุงุญโุดุฏู)
# ูุฑ ุณุฑูุงู ู ูุณุท ุจุฑฺฏุดุช ุนูุฑ ถ ูุงู ุฏุงุฑุฏ ู ุจูโุตูุฑุช ุทุจุน ุฑุดุฏ ูโฺฉูุฏ.
# ======================================================

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt

# ----------------------------
# โ๏ธ ุชูุธูุงุช ูพุงู
# ----------------------------
st.set_page_config(page_title="Real Installment Investment", layout="wide")

st.title("๐ฐ ูุงุดูโุญุณุงุจ ูุงูุน ฺฏุฑุฏุด ุงูุณุงุท ฺฉุณุจโูฺฉุงุฑ")

st.markdown("""
ูุฏู ูุงูุน ุฌุฑุงู ููุฏ ฺฉุณุจโูฺฉุงุฑ ุดูุง:  
ูุฑ ูุจูุบ ุณุฑูุงูโฺฏุฐุงุฑ (ุง ูุณุท ุจุฑฺฏุดุช) ุจุฑุง ถ ูุงู ุฏุฑ ุจุงุฒุงุฑ ูโูุงูุฏ.  
ูุฑ ูุงู ฑ/ถ ุงุฒ ุงุตู ู ุณูุฏ ุขู ุจุงุฒูโฺฏุฑุฏุฏ ู ููุงู ูุจูุบ ุฏูุจุงุฑู ุจุง ููุงู ุดุฑุงุท ูุงุฑุฏ ฺุฑุฎู ูโุดูุฏ.
""")

# ----------------------------
# ๐งฎ ูุฑูุฏโูุง
# ----------------------------
col1, col2, col3 = st.columns(3)
with col1:
    principal = st.number_input("๐ต ุณุฑูุงู ุงููู (ุชููุงู)", value=100_000_000, step=1_000_000)
with col2:
    monthly_rate = st.number_input("๐ ุณูุฏ ูุงูุงูู (%)", value=6.0, step=0.5) / 100
with col3:
    total_months = st.number_input("โณ ูุฏุช ุดุจูโุณุงุฒ (ูุงู)", value=24, step=6)

withdraw_ratio = st.slider(
    "๐ณ ุฏุฑุตุฏ ููุฏโุณุงุฒ ุงูุณุงุท ุจุงุฒฺฏุดุช (%)",
    min_value=0, max_value=100, value=0, step=5,
    help="ุงฺฏุฑ ูโุฎูุงู ุจุฎุด ุงุฒ ุงูุณุงุท ุงุฒ ฺุฑุฎู ุฎุงุฑุฌ ุดููุฏ (ูุซูุงู ุจุฑุง ููุฏ ุดุฏู ูุงูุงูู)."
) / 100

# ----------------------------
# ๐ข ูพุงุฑุงูุชุฑูุง ุงูุณุงุท
# ----------------------------
n_installments = 6
installment_factor = 1 + (n_installments * monthly_rate)  # 1.36 ุฏุฑ ูุซุงู ถูช
installment_ratio = installment_factor / n_installments   # ูุฑ ูุณุท = 22.66ูช ุงุฒ ุงุตู

# ----------------------------
# ๐ ูุญุงุณุจุงุช ุงุตู
# ----------------------------
investments = [{"amount": principal, "months_left": n_installments}]
records = []
total_withdrawn = 0

for month in range(1, int(total_months) + 1):
    returned = 0
    new_investments = []

    # ูุฑ ุณุฑูุงู ูุนุงู ฺฉ ูุณุท ูโูพุฑุฏุงุฒุฏ
    for inv in investments:
        amount = inv["amount"]
        months_left = inv["months_left"] - 1
        monthly_payment = (amount * installment_factor) / n_installments
        returned += monthly_payment

        # ุงฺฏุฑ ูููุฒ ูุงูโูุง ุงุฒ ุนูุฑ ุณุฑูุงู ูุงูุฏู
        if months_left > 0:
            new_investments.append({"amount": amount, "months_left": months_left})

    # ุฏุฑุตุฏ ููุฏ ุงุฒ ุงูุณุงุท ฺฉุณุฑ ูโุดูุฏ
    withdrawn = returned * withdraw_ratio
    total_withdrawn += withdrawn
    reinvested = returned - withdrawn

    # ุงูุณุงุท ุจุฑฺฏุดุช ุฌุฏุฏ ูุงุฑุฏ ุจุงุฒุงุฑ ูโุดููุฏ (ถ ูุงูู)
    if reinvested > 0:
        new_investments.append({"amount": reinvested, "months_left": n_installments})

    # ุจุฑูุฒุฑุณุงู ุณุฑูุงูโูุง ูุนุงู
    investments = new_investments
    total_active = sum(inv["amount"] for inv in investments)
    total_profit = total_active + total_withdrawn - principal
    roi = (total_profit / principal) * 100

    # ุซุจุช ุฏุฑ ุฌุฏูู
    records.append([
        month, returned, withdrawn, total_withdrawn, reinvested, total_active, total_profit, roi
    ])

# ----------------------------
# ๐งพ ุฌุฏูู ูุชุงุฌ
# ----------------------------
df = pd.DataFrame(records, columns=[
    "ูุงู", "ุงูุณุงุท ุจุฑฺฏุดุช (ุชููุงู)", "ุจุฑุฏุงุดุช ูุงูุงูู (ุชููุงู)", "ุฌูุน ุจุฑุฏุงุดุชโูุง (ุชููุงู)",
    "ูุจูุบ ูุฌุฏุฏุงู ุณุฑูุงูโฺฏุฐุงุฑโุดุฏู (ุชููุงู)", "ุณุฑูุงู ูุนุงู (ุชููุงู)", "ุณูุฏ ฺฉู (ุชููุงู)", "ุจุงุฒุฏู ฺฉู (%)"
])

st.markdown("### ๐ ุฌุฏูู ฺฏุฑุฏุด ุงูุณุงุท ูุงูโุจูโูุงู")
st.dataframe(df.style.format({
    "ุงูุณุงุท ุจุฑฺฏุดุช (ุชููุงู)": "{:,.0f}",
    "ุจุฑุฏุงุดุช ูุงูุงูู (ุชููุงู)": "{:,.0f}",
    "ุฌูุน ุจุฑุฏุงุดุชโูุง (ุชููุงู)": "{:,.0f}",
    "ูุจูุบ ูุฌุฏุฏุงู ุณุฑูุงูโฺฏุฐุงุฑโุดุฏู (ุชููุงู)": "{:,.0f}",
    "ุณุฑูุงู ูุนุงู (ุชููุงู)": "{:,.0f}",
    "ุณูุฏ ฺฉู (ุชููุงู)": "{:,.0f}",
    "ุจุงุฒุฏู ฺฉู (%)": "{:.2f}"
}))

# ----------------------------
# ๐ ูููุฏุงุฑ ุฑุดุฏ
# ----------------------------
st.markdown("### ๐ ุฑุดุฏ ุณุฑูุงู ูุนุงู ู ุงูุณุงุท ุจุงุฒฺฏุดุช")

fig, ax = plt.subplots(figsize=(8, 4))
ax.plot(df["ูุงู"], df["ุณุฑูุงู ูุนุงู (ุชููุงู)"], color="#86A789", marker="o", linewidth=2, label="ุณุฑูุงู ูุนุงู")
ax.bar(df["ูุงู"], df["ุงูุณุงุท ุจุฑฺฏุดุช (ุชููุงู)"], color="#FFD29C", alpha=0.6, label="ุงูุณุงุท ุจุงุฒฺฏุดุช")
ax.legend()
ax.grid(True, linestyle="--", alpha=0.5)
st.pyplot(fig)

# ----------------------------
# ๐พ ุฏุงูููุฏ ุฎุฑูุฌ
# ----------------------------
csv_data = df.to_csv(index=False).encode("utf-8-sig")
st.download_button(
    label="โฌ๏ธ ุฏุงูููุฏ ุฎุฑูุฌ (CSV)",
    data=csv_data,
    file_name="real_installment_investment.csv",
    mime="text/csv"
)

# ----------------------------
# ๐ ุชูุถุญ ูุฏู
# ----------------------------
st.markdown("""
---
### ๐ ุชูุถุญ ูุฏู:
- ูุฑ ุณุฑูุงู (ุง ูุณุท ุจุฑฺฏุดุช) ุจุฑุง ถ ูุงู ุฏุฑ ุจุงุฒุงุฑ ูุนุงู ุงุณุช.  
- ุฏุฑ ูุฑ ูุงูุ ฑ/ถ ุงุฒ ุงุตู ู ุณูุฏุด ุจุงุฒูโฺฏุฑุฏุฏ.  
- ุงูุณุงุท ุฌุฏุฏ ุฏูุจุงุฑู ุจุง ููุงู ุดุฑุงุท ุณุฑูุงูโฺฏุฐุงุฑ ูโุดููุฏ.  
- ูฺ ุณุฑูุงูโุง ุญุฐู ููโุดูุฏ ุชุง ุนูุฑุด ุชูุงู ุดูุฏ.  
- ุฑุดุฏ ุณุฑูุงู ูุงูุน ู ูพูุณุชู ุงุณุช (ูู ุงููุฌุงุฑ ู ุบุฑูุงูุน).  
---
""")
